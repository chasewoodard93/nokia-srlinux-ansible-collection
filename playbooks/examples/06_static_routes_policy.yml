---
# 06_static_routes_policy.yml - Static Routes and Routing Policy
#
# Usage:
#   ansible-playbook 06_static_routes_policy.yml -i inventory/hosts.yml

- name: "Static Routes and Routing Policy Configuration"
  hosts: all
  gather_facts: false
  
  vars:
    # ─────────────────────────────────────────────────────────
    # Static Routes
    # ─────────────────────────────────────────────────────────
    static_routes:
      - network_instance: "default"
        routes:
          - prefix: "192.168.0.0/16"
            next_hop: "10.0.0.1"
            preference: 10
            description: "Route to internal networks"
          - prefix: "172.16.0.0/12"
            next_hop: "10.0.0.1"
            description: "Route to private networks"

      - network_instance: "mgmt"
        routes:
          - prefix: "0.0.0.0/0"
            next_hop: "172.20.20.1"
            description: "Default route for management"

    # ─────────────────────────────────────────────────────────
    # Routing Policy - Prefix Lists
    # ─────────────────────────────────────────────────────────
    routing_policy_prefix_lists:
      - name: "LOOPBACKS"
        prefixes:
          - prefix: "10.0.0.0/24"
            mask_range: "32..32"
      - name: "CONNECTED"
        prefixes:
          - prefix: "10.0.0.0/8"
            mask_range: "8..30"
      - name: "DEFAULT-ROUTE"
        prefixes:
          - prefix: "0.0.0.0/0"
            mask_range: "exact"

    # ─────────────────────────────────────────────────────────
    # Routing Policy - Community Lists
    # ─────────────────────────────────────────────────────────
    routing_policy_community_lists:
      - name: "INTERNAL"
        members:
          - "65000:100"
      - name: "CUSTOMER"
        members:
          - "65000:200"

    # ─────────────────────────────────────────────────────────
    # Routing Policy - Route Policies
    # ─────────────────────────────────────────────────────────
    routing_policy_policies:
      - name: "EXPORT-LOOPBACKS"
        statements:
          - sequence: 10
            match:
              prefix_list: "LOOPBACKS"
            action: "accept"
          - sequence: 1000
            action: "reject"
      - name: "IMPORT-ALL"
        statements:
          - sequence: 1000
            action: "accept"

    routing_policy_default_action: "reject"

  tasks:
    - name: "Configure Routing Policy"
      import_role:
        name: chasewoodard93.srlinux.routing_policy

    - name: "Configure Static Routes"
      import_role:
        name: chasewoodard93.srlinux.static_routes

    - name: "Routing Configuration Complete"
      debug:
        msg: |
          ✅ Routing Configuration Complete
          ──────────────────────────────────
          Device: {{ inventory_hostname }}
          Prefix Lists: {{ routing_policy_prefix_lists | length }}
          Community Lists: {{ routing_policy_community_lists | length }}
          Route Policies: {{ routing_policy_policies | length }}
          Static Routes: {{ static_routes | map(attribute='routes') | flatten | length }}

