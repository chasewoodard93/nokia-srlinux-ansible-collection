---
# Example Playbook: ESI Multihoming Configuration
# Configures EVPN Ethernet Segment for dual-homed server connectivity
#
# Usage:
#   ansible-playbook 11_esi_multihoming.yml -i inventory/hosts.yml
#
# This playbook demonstrates:
#   - Ethernet Segment Identifier (ESI) configuration
#   - EVPN multihoming for server redundancy
#   - All-active or single-active modes
#   - DF election algorithm selection

- name: Configure EVPN ESI Multihoming
  hosts: leaf
  gather_facts: false
  vars:
    # ESI Multihoming configuration
    esi_enabled: true
    
    # Ethernet Segments for dual-homed servers
    ethernet_segments:
      - name: es-server-1
        esi: "00:11:22:33:44:55:66:77:88:01"
        interface: ethernet-1/10
        admin_state: enable
        multi_homing_mode: all-active
        df_election:
          algorithm: default
          preference: 100
          
      - name: es-server-2
        esi: "00:11:22:33:44:55:66:77:88:02"
        interface: ethernet-1/11
        admin_state: enable
        multi_homing_mode: all-active
        df_election:
          algorithm: preference
          preference: 200
          
      - name: es-storage
        esi: "00:11:22:33:44:55:66:77:88:03"
        interface: lag1
        admin_state: enable
        multi_homing_mode: single-active
        df_election:
          algorithm: default

  tasks:
    - name: Display ESI configuration to be applied
      ansible.builtin.debug:
        msg: |
          Configuring {{ ethernet_segments | length }} Ethernet Segments:
          {% for es in ethernet_segments %}
          - {{ es.name }}: ESI={{ es.esi }}, Mode={{ es.multi_homing_mode }}
          {% endfor %}

    - name: Apply ESI Multihoming configuration
      ansible.builtin.include_role:
        name: chasewoodard93.srlinux.esi_multihoming
      vars:
        esi_multihoming_enabled: "{{ esi_enabled }}"
        esi_ethernet_segments: "{{ ethernet_segments }}"

    - name: Verify ESI configuration
      chasewoodard93.srlinux.srlinux_command:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        commands:
          - show system network-instance ethernet-segments
          - show system network-instance ethernet-segments detail
      register: esi_status

    - name: Display ESI status
      ansible.builtin.debug:
        var: esi_status.stdout_lines

