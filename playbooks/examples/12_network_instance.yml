---
# Example Playbook: Network Instance Management
# Configures network-instances (VRFs) for network virtualization
#
# Usage:
#   ansible-playbook 12_network_instance.yml -i inventory/hosts.yml
#
# This playbook demonstrates:
#   - IP-VRF configuration for L3 services
#   - MAC-VRF configuration for L2 services
#   - Interface binding to network instances
#   - Route distinguisher and route target configuration

- name: Configure Network Instances
  hosts: srlinux
  gather_facts: false
  vars:
    # Network instances to configure
    network_instances:
      # L3 VRF for tenant 1
      - name: tenant-1-vrf
        type: ip-vrf
        admin_state: enable
        description: "Tenant 1 L3 VRF"
        router_id: 10.1.1.1
        route_distinguisher: "65000:100"
        route_target:
          import: ["65000:100"]
          export: ["65000:100"]
        interfaces:
          - ethernet-1/1.100
          - ethernet-1/2.100
          
      # L3 VRF for tenant 2
      - name: tenant-2-vrf
        type: ip-vrf
        admin_state: enable
        description: "Tenant 2 L3 VRF"
        router_id: 10.2.1.1
        route_distinguisher: "65000:200"
        route_target:
          import: ["65000:200"]
          export: ["65000:200"]
        interfaces:
          - ethernet-1/1.200
          
      # L2 MAC-VRF for VXLAN
      - name: mac-vrf-100
        type: mac-vrf
        admin_state: enable
        description: "VLAN 100 MAC-VRF"
        vxlan_interface: vxlan1.100
        interfaces:
          - ethernet-1/10.100
          - ethernet-1/11.100

  tasks:
    - name: Display network instances to configure
      ansible.builtin.debug:
        msg: |
          Configuring {{ network_instances | length }} network instances:
          {% for ni in network_instances %}
          - {{ ni.name }} ({{ ni.type }}): {{ ni.description }}
          {% endfor %}

    - name: Apply network instance configuration
      ansible.builtin.include_role:
        name: chasewoodard93.srlinux.network_instance
      vars:
        network_instance_list: "{{ network_instances }}"

    - name: Verify network instance configuration
      chasewoodard93.srlinux.srlinux_command:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        commands:
          - show network-instance summary
          - show network-instance * protocols
      register: ni_status

    - name: Display network instance status
      ansible.builtin.debug:
        var: ni_status.stdout_lines

