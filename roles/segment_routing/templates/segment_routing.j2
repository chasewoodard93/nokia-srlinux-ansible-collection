{# Segment Routing configuration template for SR Linux #}

{% if sr_enabled | default(true) %}
{# ============================================================================ #}
{# SR-MPLS Global Configuration                                                #}
{# ============================================================================ #}
{% if sr_type in ['sr-mpls', 'both'] %}

{# SRGB Configuration #}
set / network-instance {{ sr_network_instance }} segment-routing mpls global-block label-range start {{ sr_mpls_srgb_start }} end {{ sr_mpls_srgb_start + sr_mpls_srgb_range - 1 }}

{# SRLB Configuration #}
set / network-instance {{ sr_network_instance }} segment-routing mpls local-block label-range start {{ sr_mpls_srlb_start }} end {{ sr_mpls_srlb_start + sr_mpls_srlb_range - 1 }}

{# ============================================================================ #}
{# Prefix SIDs                                                                 #}
{# ============================================================================ #}
{% for psid in sr_mpls_prefix_sids %}
set / network-instance {{ sr_network_instance }} segment-routing mpls prefix-sid prefix {{ psid.prefix }} index {{ psid.index }}
{% if psid.algorithm is defined and psid.algorithm != 0 %}
set / network-instance {{ sr_network_instance }} segment-routing mpls prefix-sid prefix {{ psid.prefix }} algorithm {{ psid.algorithm }}
{% endif %}
{% endfor %}

{# ============================================================================ #}
{# Adjacency SIDs                                                              #}
{# ============================================================================ #}
{% for asid in sr_mpls_adj_sids %}
set / network-instance {{ sr_network_instance }} segment-routing mpls interface {{ asid.interface }} adjacency-sid value {{ asid.value }}
{% if asid.protected | default(false) %}
set / network-instance {{ sr_network_instance }} segment-routing mpls interface {{ asid.interface }} adjacency-sid protected true
{% endif %}
{% endfor %}

{# ============================================================================ #}
{# TI-LFA Configuration                                                        #}
{# ============================================================================ #}
{% if sr_tilfa_enabled | default(true) %}
set / network-instance {{ sr_network_instance }} segment-routing mpls ti-lfa admin-state enable
set / network-instance {{ sr_network_instance }} segment-routing mpls ti-lfa protection {{ sr_tilfa_protection | default('node') }}
{% endif %}

{% endif %}

{# ============================================================================ #}
{# SRv6 Configuration                                                          #}
{# ============================================================================ #}
{% if sr_type in ['srv6', 'both'] and srv6_locator is defined %}

set / network-instance {{ sr_network_instance }} segment-routing srv6 locator {{ srv6_locator.name }} prefix {{ srv6_locator.prefix }}
{% if srv6_locator.block_length is defined %}
set / network-instance {{ sr_network_instance }} segment-routing srv6 locator {{ srv6_locator.name }} block-length {{ srv6_locator.block_length }}
{% endif %}
{% if srv6_locator.node_length is defined %}
set / network-instance {{ sr_network_instance }} segment-routing srv6 locator {{ srv6_locator.name }} node-length {{ srv6_locator.node_length }}
{% endif %}
{% if srv6_locator.function_length is defined %}
set / network-instance {{ sr_network_instance }} segment-routing srv6 locator {{ srv6_locator.name }} function-length {{ srv6_locator.function_length }}
{% endif %}

{% for sid in srv6_sids %}
set / network-instance {{ sr_network_instance }} segment-routing srv6 locator {{ srv6_locator.name }} static-function {{ sid.function }} sid {{ sid.value }}
{% if sid.network_instance is defined %}
set / network-instance {{ sr_network_instance }} segment-routing srv6 locator {{ srv6_locator.name }} static-function {{ sid.function }} network-instance {{ sid.network_instance }}
{% endif %}
{% endfor %}

{% endif %}

{# ============================================================================ #}
{# Flex-Algo Configuration                                                     #}
{# ============================================================================ #}
{% for algo in sr_flex_algo %}
set / network-instance {{ sr_network_instance }} segment-routing mpls flex-algo {{ algo.id }} admin-state enable
set / network-instance {{ sr_network_instance }} segment-routing mpls flex-algo {{ algo.id }} metric-type {{ algo.metric_type }}
{% if algo.priority is defined %}
set / network-instance {{ sr_network_instance }} segment-routing mpls flex-algo {{ algo.id }} priority {{ algo.priority }}
{% endif %}
{% endfor %}

{# ============================================================================ #}
{# SR Policies                                                                 #}
{# ============================================================================ #}
{% for policy in sr_policies %}
set / network-instance {{ sr_network_instance }} segment-routing sr-policy {{ policy.name }} color {{ policy.color }}
set / network-instance {{ sr_network_instance }} segment-routing sr-policy {{ policy.name }} endpoint {{ policy.endpoint }}
{% if policy.binding_sid is defined %}
set / network-instance {{ sr_network_instance }} segment-routing sr-policy {{ policy.name }} binding-sid {{ policy.binding_sid }}
{% endif %}
{% for sl in policy.segment_lists | default([]) %}
set / network-instance {{ sr_network_instance }} segment-routing sr-policy {{ policy.name }} segment-list {{ sl.name }} weight {{ sl.weight | default(1) }}
{% for seg in sl.segments | default([]) %}
set / network-instance {{ sr_network_instance }} segment-routing sr-policy {{ policy.name }} segment-list {{ sl.name }} segment index {{ loop.index }} type {{ seg.type }} value {{ seg.value }}
{% endfor %}
{% endfor %}
{% endfor %}

{% endif %}

